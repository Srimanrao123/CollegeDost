import { useState, useRef, useEffect } from "react";
import { Smile } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";

// Common emoji categories
const EMOJI_CATEGORIES = {
  smileys: ["ðŸ˜€", "ðŸ˜ƒ", "ðŸ˜„", "ðŸ˜", "ðŸ˜†", "ðŸ˜…", "ðŸ¤£", "ðŸ˜‚", "ðŸ™‚", "ðŸ™ƒ", "ðŸ˜‰", "ðŸ˜Š", "ðŸ˜‡", "ðŸ¥°", "ðŸ˜", "ðŸ¤©", "ðŸ˜˜", "ðŸ˜—", "ðŸ˜š", "ðŸ˜™"],
  gestures: ["ðŸ‘‹", "ðŸ¤š", "ðŸ–", "âœ‹", "ðŸ––", "ðŸ‘Œ", "ðŸ¤", "âœŒï¸", "ðŸ¤ž", "ðŸ¤Ÿ", "ðŸ¤˜", "ðŸ¤™", "ðŸ‘ˆ", "ðŸ‘‰", "ðŸ‘†", "ðŸ–•", "ðŸ‘‡", "â˜ï¸", "ðŸ‘", "ðŸ‘Ž"],
  hearts: ["â¤ï¸", "ðŸ§¡", "ðŸ’›", "ðŸ’š", "ðŸ’™", "ðŸ’œ", "ðŸ–¤", "ðŸ¤", "ðŸ¤Ž", "ðŸ’”", "â¤ï¸â€ðŸ”¥", "ðŸ’•", "ðŸ’ž", "ðŸ’“", "ðŸ’—", "ðŸ’–", "ðŸ’˜", "ðŸ’", "ðŸ’Ÿ", "â£ï¸"],
  objects: ["âŒš", "ðŸ“±", "ðŸ“²", "ðŸ’»", "âŒ¨ï¸", "ðŸ–¥ï¸", "ðŸ–¨ï¸", "ðŸ–±ï¸", "ðŸ–²ï¸", "ðŸ•¹ï¸", "ðŸ—œï¸", "ðŸ’¾", "ðŸ’¿", "ðŸ“€", "ðŸ“¼", "ðŸ“·", "ðŸ“¸", "ðŸ“¹", "ðŸŽ¥", "ðŸ“½ï¸"],
  symbols: ["â¤ï¸", "ðŸ’¯", "âœ…", "â­", "ðŸŒŸ", "âœ¨", "ðŸ”¥", "ðŸ’ª", "ðŸ‘", "ðŸ‘Ž", "ðŸŽ‰", "ðŸŽŠ", "ðŸŽˆ", "ðŸŽ", "ðŸ†", "ðŸ¥‡", "ðŸ¥ˆ", "ðŸ¥‰", "âš¡", "ðŸ’¡"],
};

const ALL_EMOJIS = [
  ...EMOJI_CATEGORIES.smileys,
  ...EMOJI_CATEGORIES.gestures,
  ...EMOJI_CATEGORIES.hearts,
  ...EMOJI_CATEGORIES.objects,
  ...EMOJI_CATEGORIES.symbols,
];

interface EmojiPickerProps {
  onEmojiSelect: (emoji: string) => void;
  trigger?: React.ReactNode;
}

export function EmojiPicker({ onEmojiSelect, trigger }: EmojiPickerProps) {
  const [open, setOpen] = useState(false);
  const popoverRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (popoverRef.current && !popoverRef.current.contains(event.target as Node)) {
        setOpen(false);
      }
    };

    if (open) {
      document.addEventListener("mousedown", handleClickOutside);
    }

    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [open]);

  const handleEmojiClick = (emoji: string) => {
    onEmojiSelect(emoji);
    setOpen(false);
  };

  return (
    <Popover open={open} onOpenChange={setOpen}>
      <PopoverTrigger asChild>
        {trigger || (
          <Button
            type="button"
            variant="ghost"
            size="icon"
            className="h-8 w-8"
            onClick={(e) => {
              e.preventDefault();
              e.stopPropagation();
              setOpen(!open);
            }}
          >
            <Smile className="h-4 w-4" />
          </Button>
        )}
      </PopoverTrigger>
      <PopoverContent 
        ref={popoverRef}
        className="w-80 p-2 bg-popover border border-border shadow-lg"
        align="start"
        side="top"
      >
        <div className="max-h-64 overflow-y-auto">
          <div className="grid grid-cols-8 gap-1">
            {ALL_EMOJIS.map((emoji, index) => (
              <button
                key={index}
                type="button"
                className="text-2xl hover:bg-accent rounded-md p-2 transition-colors cursor-pointer"
                onClick={() => handleEmojiClick(emoji)}
                title={emoji}
              >
                {emoji}
              </button>
            ))}
          </div>
        </div>
      </PopoverContent>
    </Popover>
  );
}

